name: ðŸŽ® Game Evolution

on:
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      analyze_only:
        description: 'Only analyze metrics (no content generation)'
        required: false
        default: 'false'
        type: boolean

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd packages/game-evolution
          npm install

      - name: Run Evolution Analysis
        id: evolve
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd packages/game-evolution

          if [ "${{ inputs.analyze_only }}" = "true" ]; then
            npm run analyze
          else
            npm run evolve -- --output=../../evolution-plans

            # Get the plan ID
            PLAN_ID=$(ls ../../evolution-plans/*.json | head -1 | xargs basename .json)
            echo "plan_id=$PLAN_ID" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: ${{ inputs.analyze_only != 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸŽ® Game Evolution Plan: ${{ steps.evolve.outputs.plan_id }}'
          title: 'ðŸŽ® [AI] Game Content Evolution Suggestions'
          body: |
            ## ðŸ¤– AI-Generated Game Content Suggestions

            This PR contains AI-generated content suggestions for the GrepCoin arcade games.

            ### What's Included
            - New regex patterns for Grep Rails / Regex Crossword
            - New code snippets with bugs for Bug Hunter
            - Analysis of current game metrics and player behavior

            ### Review Process
            1. Check the `evolution-plans/` folder for the full plan
            2. Review each suggestion for quality and appropriateness
            3. Test patterns/snippets manually if needed
            4. Approve and merge to add content to games

            ---
            *Generated by GrepCoin Game Evolution System using Claude AI*
          branch: ai/game-evolution-${{ github.run_number }}
          labels: |
            ai-generated
            games
            enhancement

  notify:
    needs: evolve
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ® Game Evolution Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the pull request for AI-generated content suggestions." >> $GITHUB_STEP_SUMMARY
