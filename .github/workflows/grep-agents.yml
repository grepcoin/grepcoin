name: GREP Agents (Claude-Powered)

on:
  # PR Review - triggers on new/updated PRs
  pull_request:
    types: [opened, synchronize, reopened]

  # Issue events - triage new issues, debug bugs
  issues:
    types: [opened, labeled]

  # Scheduled tasks
  schedule:
    # Security check: Every 6 hours
    - cron: '0 */6 * * *'
    # Weekly analytics: Every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
    # Feature ideas: First of each month
    - cron: '0 12 1 * *'

  # Manual trigger for any agent
  workflow_dispatch:
    inputs:
      agent:
        description: 'Which agent to run'
        required: true
        type: choice
        options:
          - pr-reviewer
          - security-guardian
          - analytics-reporter
          - issue-triage
          - debug-helper
          - feature-ideator
          - all

jobs:
  # ===========================================
  # PR Review Agent (Claude-Powered)
  # ===========================================
  pr-review:
    name: ðŸ¤– GREP PR Reviewer
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'pr-reviewer' || inputs.agent == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run PR Review Agent
        run: npx tsx packages/agents/src/github-actions/pr-reviewer.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ===========================================
  # Issue Triage Agent
  # ===========================================
  issue-triage:
    name: ðŸ·ï¸ GREP Issue Triage
    if: (github.event_name == 'issues' && github.event.action == 'opened') || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'issue-triage' || inputs.agent == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Issue Triage Agent
        run: npx tsx packages/agents/src/github-actions/issue-triage.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ===========================================
  # Debug Helper Agent (Claude-Powered)
  # ===========================================
  debug-helper:
    name: ðŸ› GREP Debug Helper
    if: (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'bug') || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'debug-helper' || inputs.agent == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Debug Helper Agent
        run: npx tsx packages/agents/src/github-actions/debug-helper.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ===========================================
  # Security Guardian Agent
  # ===========================================
  security-guardian:
    name: ðŸ›¡ï¸ GREP Security Guardian
    if: github.event.schedule == '0 */6 * * *' || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'security-guardian' || inputs.agent == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Security Guardian Agent
        run: npx tsx packages/agents/src/github-actions/security-guardian.ts
        timeout-minutes: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BLOCKCHAIN_NETWORK: testnet

  # ===========================================
  # Analytics Reporter Agent
  # ===========================================
  analytics-reporter:
    name: ðŸ“Š GREP Analytics Reporter
    if: github.event.schedule == '0 9 * * 1' || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'analytics-reporter' || inputs.agent == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Analytics Reporter Agent
        run: npx tsx packages/agents/src/github-actions/analytics-reporter.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          REPORT_TYPE: weekly

  # ===========================================
  # Feature Ideator Agent (Claude-Powered)
  # ===========================================
  feature-ideator:
    name: ðŸ’¡ GREP Feature Ideator
    if: github.event.schedule == '0 12 1 * *' || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'feature-ideator' || inputs.agent == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Feature Ideator Agent
        run: npx tsx packages/agents/src/github-actions/feature-ideator.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FOCUS_AREA: all

  # ===========================================
  # Summary Job
  # ===========================================
  summary:
    name: ðŸ“‹ GREP Agent Summary
    needs: [pr-review, issue-triage, debug-helper, security-guardian, analytics-reporter, feature-ideator]
    if: always() && github.event_name == 'workflow_dispatch' && inputs.agent == 'all'
    runs-on: ubuntu-latest

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ¤– GREP Agent Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– PR Reviewer | ${{ needs.pr-review.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Issue Triage | ${{ needs.issue-triage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ› Debug Helper | ${{ needs.debug-helper.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Security Guardian | ${{ needs.security-guardian.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Analytics Reporter | ${{ needs.analytics-reporter.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’¡ Feature Ideator | ${{ needs.feature-ideator.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by GrepCoin AI Agents + Claude*" >> $GITHUB_STEP_SUMMARY
